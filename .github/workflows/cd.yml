name: cd

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  docker:
    name: Build & Push Docker image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image base (lowercase)
        shell: bash
        run: |
          set -euo pipefail
          REPO_LC="$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')"
          echo "IMAGE_BASE=ghcr.io/${REPO_LC}" >> "$GITHUB_ENV"

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:${{ github.sha }}
            ${{ env.IMAGE_BASE }}:latest

  deploy:
    name: Deploy to Kubernetes (k3d local)
    runs-on: [self-hosted, k3d]
    needs: [docker]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image (lowercase) for deploy
        shell: bash
        run: |
          set -euo pipefail
          REPO_LC="$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')"
          echo "IMAGE=ghcr.io/${REPO_LC}:${GITHUB_SHA}" >> "$GITHUB_ENV"

      - name: Show kubectl context (debug)
        shell: bash
        run: |
          set -euo pipefail
          kubectl version --client=true
          kubectl config get-contexts
          kubectl config use-context k3d-k3s-default
          kubectl cluster-info

      - name: Login to GHCR (for pull)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Pull image + import into k3d
        shell: bash
        run: |
          set -euo pipefail
          docker pull "$IMAGE"
          k3d image import "$IMAGE" -c k3s-default

      - name: Apply namespace
        run: kubectl apply -f deploy/k8s/namespace.yml

      - name: Apply Postgres secret
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        shell: bash
        run: |
          set -euo pipefail
          kubectl -n go-rest create secret generic postgres-secret \
            --from-literal=POSTGRES_USER="$POSTGRES_USER" \
            --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            --from-literal=POSTGRES_DB="$POSTGRES_DB" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Postgres manifests
        shell: bash
        run: |
          set -euo pipefail
          kubectl apply -f deploy/k8s/postgres-service.yml
          kubectl apply -f deploy/k8s/postgres-statefulset.yml

      - name: Wait for Postgres
        shell: bash
        run: |
          set -euo pipefail
          kubectl -n go-rest rollout status statefulset/postgres --timeout=180s
          kubectl -n go-rest get pods -l app=postgres

      - name: Apply app config secret
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          JWT_SIGNING_KEY: ${{ secrets.JWT_SIGNING_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          DSN="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable"

          cat > /tmp/config.yml <<EOF
          dsn: "${DSN}"
          jwt_signing_key: "${JWT_SIGNING_KEY}"
          EOF

          kubectl -n go-rest create secret generic go-rest-api-config \
            --from-file=config.yml=/tmp/config.yml \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply app manifests
        shell: bash
        run: |
          set -euo pipefail
          kubectl apply -f deploy/k8s/deployment.yml
          kubectl apply -f deploy/k8s/service.yml

      - name: Rollout new image (api + initContainer)
        shell: bash
        run: |
          set -euo pipefail

          kubectl -n go-rest set image deployment/go-rest-api api="$IMAGE"

          kubectl -n go-rest patch deployment go-rest-api --type='json' \
            -p="[{\"op\":\"replace\",\"path\":\"/spec/template/spec/initContainers/0/image\",\"value\":\"${IMAGE}\"}]"

          kubectl -n go-rest rollout status deployment/go-rest-api --timeout=180s
